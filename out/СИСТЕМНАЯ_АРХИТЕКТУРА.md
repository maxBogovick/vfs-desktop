# СИСТЕМНАЯ АРХИТЕКТУРА VFDIR

## Обзор проекта

**VFDir** - современный двухпанельный файловый менеджер с аутентичным дизайном Windows XP Luna, построенный на технологическом стеке **Tauri 2** (Rust backend + Vue 3 frontend). Приложение предоставляет полнофункциональный интерфейс для управления файлами с расширенными возможностями группировки, фильтрации, и двухпанельной навигации.

---

## 1. АРХИТЕКТУРА ПРИЛОЖЕНИЯ

### 1.1 Общая структура

```
┌─────────────────────────────────────────────────────────────┐
│                     VFDir Desktop App                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │          Frontend (Vue 3 + TypeScript)                │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  UI Components (18 компонентов)                 │  │  │
│  │  │  • Toolbar, FileList, Sidebar, Preview, etc.    │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Composables (20 переиспользуемых модулей)      │  │  │
│  │  │  • useFileSystem, useNavigation, useSelection   │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  State Management (Reactive Refs + Composables) │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                           ↕                                   │
│                    Tauri IPC Bridge                          │
│                  (@tauri-apps/api)                           │
│                           ↕                                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │           Backend (Rust + Tauri 2)                    │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Tauri Commands (40+ команд)                    │  │  │
│  │  │  • File operations, Navigation, System info     │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Core FileSystem Trait                          │  │  │
│  │  │  ├─ RealFileSystem (std::fs)                    │  │  │
│  │  │  └─ VirtualFileSystem (in-memory)               │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  File Operations с Progress Tracking            │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                           ↕                                   │
│                   Operating System                           │
│              (macOS / Windows / Linux)                       │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 Frontend архитектура (Vue 3 + TypeScript)

#### Структура директорий
```
src/
├── App.vue                 # Главный компонент приложения
├── components/             # 18 Vue компонентов
│   ├── Toolbar.vue
│   ├── FileList.vue
│   ├── FilePanel.vue
│   ├── Sidebar.vue
│   ├── Preview.vue
│   ├── Dashboard.vue
│   ├── CommandPalette.vue
│   ├── ContextMenu.vue
│   ├── ConfirmDialog.vue
│   ├── InputDialog.vue
│   ├── PropertiesDialog.vue
│   ├── Settings.vue
│   ├── Notifications.vue
│   ├── OperationsProgress.vue
│   ├── DualPanelContainer.vue
│   ├── PanelToolbar.vue
│   ├── TreeNode.vue
│   └── GroupByDropdown.vue
├── composables/            # 20 Vue composables
│   ├── useFileSystem.ts
│   ├── useNavigation.ts
│   ├── useSelection.ts
│   ├── useSearch.ts
│   ├── useDragDrop.ts
│   ├── useKeyboard.ts
│   ├── useDialogs.ts
│   ├── useFileOperations.ts
│   ├── useClipboard.ts
│   ├── useBookmarks.ts
│   ├── useUIState.ts
│   ├── useDualPanel.ts
│   ├── useDirectoryTree.ts
│   ├── useFileContentCache.ts
│   ├── useFileOperationsProgress.ts
│   ├── useNotifications.ts
│   ├── useCommands.ts
│   ├── useContextMenu.ts
│   ├── useGrouping.ts
│   └── useSwipeNavigation.ts
├── types/                  # TypeScript типы и интерфейсы
│   └── index.ts
└── utils/                  # Утилиты
    └── keyboardShortcuts.ts
```

#### Технологический стек Frontend
- **Vue 3.5** - Composition API с `<script setup>`
- **TypeScript 5.6** - Строгая типизация
- **Tailwind CSS 4.1** - Utility-first CSS фреймворк
- **Vite 6** - Молниеносная сборка и HMR
- **@tauri-apps/api** - IPC мост для связи с Rust backend

### 1.3 Backend архитектура (Rust + Tauri 2)

#### Структура директорий
```
src-tauri/src/
├── api/                    # Реализация файловых систем
│   ├── real_fs.rs         # RealFileSystem (std::fs)
│   └── virtual_fs.rs      # VirtualFileSystem (in-memory)
├── core/                   # Core traits и структуры
│   ├── filesystem.rs      # FileSystem trait (основной контракт)
│   ├── file.rs            # File структура
│   ├── directory.rs       # Directory структура
│   ├── metadata.rs        # Metadata структура
│   ├── node.rs            # FileSystemNode enum
│   └── mod.rs             # Module exports
├── application/            # Application layer
│   └── mod.rs
├── commands.rs             # Tauri commands (521 строк, 40+ команд)
├── config.rs               # Configuration structures
├── file_operations.rs      # File copy/move/delete с progress
├── progress.rs             # Progress tracking system
├── error.rs                # Error types и обработка
└── lib.rs                  # Tauri app initialization
```

#### Технологический стек Backend
- **Rust Edition 2021** - Системный язык программирования
- **Tauri 2** - Desktop framework
- **serde/serde_json** - Serialization/Deserialization
- **dirs 5.0** - Системные пути (home, config, documents)
- **base64 0.22** - Encoding для изображений
- **sysinfo 0.33** - System monitoring (CPU, RAM, Disk)
- **once_cell 1.19** - Lazy static инициализация
- **llm-utl 0.1.5** - Utilities

---

## 2. КЛЮЧЕВЫЕ КОМПОНЕНТЫ

### 2.1 Vue Components (18 компонентов)

| Компонент | Ответственность | Ключевые возможности |
|-----------|----------------|---------------------|
| **App.vue** | Главный контейнер | Корневой компонент, роутинг режимов (single/dual panel) |
| **Toolbar.vue** | Навигационная панель | Back/Forward/Up, табы, breadcrumbs, режимы просмотра, закладки |
| **FileList.vue** | Список файлов | Grid/List/Details view, выделение, drag-drop, группировка |
| **FilePanel.vue** | Панель для dual-mode | Отдельная панель с собственным состоянием |
| **Sidebar.vue** | Боковая панель | Дерево папок, быстрый доступ, системные папки, закладки |
| **Preview.vue** | Предпросмотр файлов | Свойства файла, рекурсивный расчет размера директорий |
| **Dashboard.vue** | Системная информация | CPU, RAM, Disk usage с live обновлением |
| **CommandPalette.vue** | Быстрый доступ | Ctrl+K палитра команд |
| **ContextMenu.vue** | Контекстное меню | Right-click меню на файлах |
| **ConfirmDialog.vue** | Диалог подтверждения | Подтверждение удаления и критичных операций |
| **InputDialog.vue** | Ввод текста | Переименование, создание папок |
| **PropertiesDialog.vue** | Свойства файла | Детальная информация о файле/папке |
| **Settings.vue** | Настройки | Конфигурация приложения |
| **Notifications.vue** | Уведомления | Success/Warning/Error toast сообщения |
| **OperationsProgress.vue** | Прогресс операций | Progress bar для copy/move/delete с ETA |
| **DualPanelContainer.vue** | Container для dual mode | Управление двумя панелями |
| **PanelToolbar.vue** | Toolbar для панели | Отдельный toolbar для каждой панели |
| **TreeNode.vue** | Узел дерева | Рекурсивный компонент для sidebar дерева |
| **GroupByDropdown.vue** | Меню группировки | Dropdown для выбора критерия группировки |

### 2.2 Composables (20 переиспользуемых модулей)

#### Файловая система и операции
- **useFileSystem** - Работа с файловой системой (чтение директорий, информация о файлах)
- **useFileOperations** - Высокоуровневые операции (copy, cut, paste, delete, rename)
- **useFileOperationsProgress** - Отслеживание прогресса длительных операций
- **useFileContentCache** - Кеширование содержимого файлов

#### Навигация и выделение
- **useNavigation** - Мультитабы, история, breadcrumbs, Back/Forward
- **useSelection** - Выделение файлов (одиночное, мультиселект, диапазон)
- **useDualPanel** - Двухпанельный режим (состояние обеих панелей)

#### Поиск и фильтрация
- **useSearch** - Поиск и фильтрация (по типу, размеру, дате, тегам)
- **useGrouping** - Группировка файлов по различным критериям

#### UI взаимодействия
- **useDragDrop** - Drag & Drop операции, глобальное состояние
- **useKeyboard** - Обработка горячих клавиш
- **useContextMenu** - Управление контекстным меню
- **useSwipeNavigation** - Свайп-навигация для touch устройств

#### Диалоги и уведомления
- **useDialogs** - Управление диалогами (подтверждение, ввод, свойства)
- **useNotifications** - Система уведомлений

#### Система и состояние
- **useClipboard** - Буфер обмена (copy/cut/paste)
- **useBookmarks** - Работа с закладками
- **useUIState** - Сохранение состояния UI (размеры панелей, развернутые папки)
- **useDirectoryTree** - Дерево папок для sidebar (lazy load)
- **useCommands** - Command palette логика

---

## 3. TAURI COMMANDS (IPC Bridge)

### 3.1 Файловая система (Core Operations)

```rust
// Чтение и информация
read_directory(path: String) -> Vec<FileSystemEntry>
get_file_info(path: String) -> FileSystemEntry
get_home_directory() -> String
get_system_folders() -> SystemFolders
read_file_content(path: String, max_size: Option<u64>) -> String
normalize_path(path: String) -> String
get_path_suggestions(path: String) -> Vec<String>

// Операции с файлами
copy_items(sources: Vec<String>, destination: String) -> ()
move_items(sources: Vec<String>, destination: String) -> ()
delete_item(path: String) -> ()
rename_item(old_path: String, new_name: String) -> ()
create_folder(path: String, name: String) -> ()

// Открытие и просмотр
open_file(path: String) -> ()
reveal_in_finder(path: String) -> ()
open_terminal(path: String) -> ()

// Расчеты
calculate_directory_size(path: String) -> u64
```

### 3.2 Операции с прогрессом (Progress Tracking)

```rust
copy_items_with_progress_command(
    operation_id: String,
    sources: Vec<String>,
    destination: String
) -> ()

move_items_with_progress_command(
    operation_id: String,
    sources: Vec<String>,
    destination: String
) -> ()

delete_items_with_progress_command(
    operation_id: String,
    paths: Vec<String>
) -> ()

// Управление операциями
cancel_operation(operation_id: String) -> ()
pause_operation(operation_id: String) -> ()
resume_operation(operation_id: String) -> ()
```

### 3.3 Конфигурация и состояние

```rust
get_config() -> AppConfig
update_config(config: AppConfig) -> ()
set_filesystem_backend(backend: String) -> ()

get_ui_state() -> UIState
save_ui_state(state: UIState) -> ()
```

### 3.4 Закладки (Bookmarks)

```rust
get_bookmarks() -> Vec<Bookmark>
add_bookmark(name: String, path: String) -> ()
remove_bookmark(path: String) -> ()
rename_bookmark(path: String, new_name: String) -> ()
```

### 3.5 Система (System Information)

```rust
get_system_stats() -> SystemStats {
    cpu_usage: f32,
    ram_used: u64,
    ram_total: u64,
    disk_used: u64,
    disk_total: u64,
    uptime: u64
}
```

---

## 4. CORE BACKEND АРХИТЕКТУРА

### 4.1 FileSystem Trait (Основной контракт)

```rust
pub trait FileSystem: Send + Sync {
    // Чтение
    fn read_directory(&self, path: &str) -> Result<Vec<FileSystemEntry>>;
    fn get_file_info(&self, path: &str) -> Result<FileSystemEntry>;
    fn read_file_content(&self, path: &str, max_size: Option<u64>) -> Result<String>;

    // Операции
    fn delete_item(&self, path: &str) -> Result<()>;
    fn rename_item(&self, old_path: &str, new_name: &str) -> Result<()>;
    fn create_folder(&self, path: &str, name: &str) -> Result<()>;
    fn copy_items(&self, sources: &[String], destination: &str) -> Result<()>;
    fn move_items(&self, sources: &[String], destination: &str) -> Result<()>;

    // Системная интеграция
    fn open_file(&self, path: &str) -> Result<()>;
    fn reveal_in_finder(&self, path: &str) -> Result<()>;
    fn normalize_path(&self, path: &str) -> Result<String>;
    fn get_path_suggestions(&self, path: &str) -> Result<Vec<String>>;
}
```

### 4.2 Две реализации FileSystem

#### RealFileSystem (api/real_fs.rs)
- Использует **std::fs** для работы с реальной файловой системой ОС
- Поддержка macOS, Windows, Linux
- Реальные файловые операции
- Интеграция с системными приложениями

#### VirtualFileSystem (api/virtual_fs.rs)
- In-memory файловая система на основе JSON
- Для тестирования и демонстрации
- Быстрые операции без дискового I/O
- Полная имитация файловой системы

### 4.3 Progress Tracking System (progress.rs)

```rust
pub struct ProgressEvent {
    pub operation_id: String,
    pub operation_type: OperationType,  // Copy/Move/Delete
    pub status: OperationStatus,        // Running/Paused/Completed/Cancelled/Failed
    pub current_bytes: u64,
    pub total_bytes: u64,
    pub current_items: usize,
    pub total_items: usize,
    pub current_file: Option<String>,
    pub speed_bytes_per_sec: f64,
    pub eta_seconds: Option<f64>,
    pub error_message: Option<String>,
}
```

**Возможности:**
- Real-time обновления прогресса (через Tauri events)
- Расчет скорости передачи (bytes/sec)
- ETA (estimated time of arrival)
- Pause/Resume/Cancel операций
- Поддержка нескольких параллельных операций
- Буфер 64KB для эффективного копирования

---

## 5. STATE MANAGEMENT (Управление состоянием)

### 5.1 Глобальное состояние (Reactive Refs)

```typescript
// Буфер обмена - единый для всех панелей
const clipboard = ref<{
  items: FileItem[]
  operation: 'copy' | 'cut'
}>()

// Drag & Drop - глобальный стейт
const dragState = ref<{
  isDragging: boolean
  draggedItems: FileItem[]
  sourcePanel: 'left' | 'right' | null
  dropTarget: FileItem | null
}>()

// Двухпанельный режим
const dualPanelState = ref<{
  mode: 'single' | 'dual'
  activePanel: 'left' | 'right'
  leftPanel: PanelState
  rightPanel: PanelState
  leftPanelWidthPercent: number
}>()
```

### 5.2 Panel State (Состояние панели)

```typescript
interface PanelState {
  // Навигация
  tabs: Tab[]
  activeTabId: number

  // Просмотр
  viewMode: 'grid' | 'list' | 'details'
  sortBy: 'name' | 'date' | 'size' | 'type'
  sortOrder: 'asc' | 'desc'
  groupBy: GroupByType

  // Выделение
  selectedIds: Set<string>
  lastSelectedId: string | null
  rangeAnchorId: string | null
  focusedId: string | null

  // Поиск и фильтрация
  searchQuery: string
  filters: SearchFilter
}
```

### 5.3 Tab State (Состояние вкладки)

```typescript
interface Tab {
  id: number
  path: string[]              // ['Users', 'maxim', 'Projects']
  name: string                // 'Projects'
  history: string[][]         // История навигации
  historyIndex: number        // Текущий индекс в истории
}
```

---

## 6. ТИПЫ ДАННЫХ (TypeScript Interfaces)

### 6.1 FileItem (Основная единица файловой системы)

```typescript
interface FileItem {
  id: string                    // Уникальный ID (обычно path)
  name: string                  // Имя файла
  type: FileType               // Тип файла
  size?: number                // Размер в байтах
  sizeFormatted?: string       // '1.5 MB'
  modified?: string            // ISO timestamp
  created?: string
  accessed?: string
  path: string                 // Полный путь
  isHidden?: boolean
  permissions?: {
    readable: boolean
    writable: boolean
    executable: boolean
  }
  tags?: string[]              // Цветные метки
}

type FileType =
  | 'folder'
  | 'drive'
  | 'system'
  | 'file'
  | 'image'
  | 'code'
  | 'pdf'
  | 'video'
  | 'audio'
  | 'archive'
```

### 6.2 Configuration (AppConfig)

```typescript
interface AppConfig {
  filesystem_backend: 'real' | 'virtual'
  show_hidden_files: boolean
  default_view_mode: 'grid' | 'list' | 'details'
  theme: 'luna' | 'classic' | 'royale'
  bookmarks: Bookmark[]
  ui_state: UIState
}

interface UIState {
  sidebar_width: number
  preview_width: number
  tabs: TabState[]
  active_tab_id?: number
  last_path?: string[]
  panel_mode: 'single' | 'dual'
  dual_panel_config: DualPanelConfig
  window: WindowState
  sidebar: SidebarState
}
```

---

## 7. ИНТЕГРАЦИЯ С ОПЕРАЦИОННОЙ СИСТЕМОЙ

### 7.1 Файловые операции

**macOS:**
```rust
// Открытие файлов
Command::new("open").arg(path).spawn()

// Reveal in Finder
Command::new("open").args(&["-R", path]).spawn()

// Терминал
Command::new("/Applications/Utilities/Terminal.app")
    .arg(path)
    .spawn()
```

**Windows:**
```rust
// Открытие файлов
Command::new("cmd").args(&["/c", "start", path]).spawn()

// Reveal in Explorer
Command::new("explorer").args(&["/select,", path]).spawn()
```

**Linux:**
```rust
// Открытие файлов
Command::new("xdg-open").arg(path).spawn()
```

### 7.2 System Information (sysinfo crate)

```rust
use sysinfo::{System, SystemExt, CpuExt, DiskExt};

fn get_system_stats() -> SystemStats {
    let mut sys = System::new_all();
    sys.refresh_all();

    SystemStats {
        cpu_usage: sys.global_cpu_info().cpu_usage(),
        ram_used: sys.used_memory(),
        ram_total: sys.total_memory(),
        disk_used: sys.disks()[0].available_space(),
        disk_total: sys.disks()[0].total_space(),
        uptime: sys.uptime(),
    }
}
```

### 7.3 Configuration Persistence

**Расположение конфига:**
- macOS: `~/.config/vfdir/config.json`
- Windows: `%APPDATA%/vfdir/config.json`
- Linux: `~/.config/vfdir/config.json`

**Сохраняется:**
- UI state (размеры панелей, развернутые папки, табы)
- Bookmarks
- Settings (theme, view mode, show_hidden_files)
- Последняя открытая директория

---

## 8. DESIGN PATTERNS И BEST PRACTICES

### 8.1 Композиция вместо наследования
- Используем **Composables** вместо mixins
- Каждый composable отвечает за одну область (Single Responsibility)
- Переиспользование логики через композицию

### 8.2 Separation of Concerns
- **UI Components** - только presentation logic
- **Composables** - бизнес-логика и state management
- **Tauri Commands** - backend операции
- **Core Traits** - абстракции файловой системы

### 8.3 Type Safety
- Строгая типизация на frontend (TypeScript)
- Строгая типизация на backend (Rust)
- IPC bridge с type-safe сериализацией (serde)

### 8.4 Reactive Programming
- Vue 3 Reactivity System (ref, computed, watch)
- Reactive updates через Tauri events
- Unidirectional data flow

### 8.5 Error Handling
- Result type на backend (Rust)
- Try-catch на frontend
- User-friendly error notifications
- Graceful degradation

---

## 9. PERFORMANCE OPTIMIZATIONS

### 9.1 Frontend
- **Lazy Loading** директорий в tree view
- **Virtual Scrolling** для больших списков файлов (planned)
- **Debouncing** для поиска в реальном времени
- **Memoization** через computed properties
- **Code Splitting** через Vite

### 9.2 Backend
- **Buffered I/O** (64KB buffer для копирования)
- **Async операции** для длительных задач
- **Progress streaming** для real-time updates
- **File metadata caching** (planned)

### 9.3 IPC Optimization
- Минимизация Tauri IPC calls
- Batch операции где возможно
- Efficient serialization (serde)

---

## 10. БЕЗОПАСНОСТЬ

### 10.1 Tauri Security
- **CSP (Content Security Policy)** configured
- **IPC Whitelist** - только разрешенные команды
- **Path validation** - защита от path traversal
- **Sandboxed WebView**

### 10.2 File Operations Security
- Проверка прав доступа перед операциями
- Validation путей
- Confirmation dialogs для критичных операций
- No arbitrary code execution

---

## ИТОГИ АРХИТЕКТУРЫ

VFDir построен на современном и надежном технологическом стеке:

✅ **Modular Architecture** - четкое разделение ответственности
✅ **Type Safety** - строгая типизация на всех уровнях
✅ **Reactive** - реактивное обновление UI
✅ **Cross-platform** - macOS, Windows, Linux
✅ **Extensible** - легко добавлять новые функции через composables
✅ **Performant** - оптимизированные операции с файлами
✅ **Secure** - Tauri security model + validation

Архитектура позволяет легко расширять функциональность, поддерживать код и обеспечивает отличную производительность на всех платформах.
